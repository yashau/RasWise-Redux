<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Expense - RasWise</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/miniapp.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Add Expense</h1>
            <p id="group-name">Loading...</p>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading group information...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <form id="expense-form" style="display: none;">
            <div class="form-group">
                <label>Amount <span class="required">*</span></label>
                <input type="number" id="amount" step="0.01" min="0.01" required placeholder="0.00">
            </div>

            <div class="form-group">
                <label>Description</label>
                <input type="text" id="description" placeholder="e.g., Dinner at restaurant">
            </div>

            <div class="form-group">
                <label>Location</label>
                <input type="text" id="location" placeholder="e.g., Downtown Restaurant">
            </div>

            <div class="form-group">
                <label>Bill Photo</label>
                <div class="file-input-wrapper">
                    <input type="file" id="bill-photo" accept="image/*">
                    <div>ðŸ“· Upload bill photo</div>
                    <div class="file-preview" id="bill-preview"></div>
                </div>
            </div>

            <div class="form-group">
                <label>Vendor Payment Slip</label>
                <div class="file-input-wrapper">
                    <input type="file" id="vendor-slip" accept="image/*">
                    <div>ðŸ“· Upload payment slip</div>
                    <div class="file-preview" id="vendor-preview"></div>
                </div>
            </div>

            <div class="form-group">
                <label>Who Paid? <span class="required">*</span></label>
                <select id="paid-by" required>
                    <option value="">Select who paid...</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    Split Between <span class="required">*</span>
                    <span class="selected-count" id="selected-count" style="display: none;">0 selected</span>
                </label>
                <div class="select-actions">
                    <button type="button" class="select-action-btn" id="select-all">Select All</button>
                    <button type="button" class="select-action-btn" id="deselect-all">Deselect All</button>
                </div>
                <div id="user-selection" class="user-selection-grid"></div>
            </div>

            <div class="form-group">
                <label>Split Type <span class="required">*</span></label>
                <select id="split-type" required>
                    <option value="equal">Equal Split</option>
                    <option value="custom">Custom Amounts</option>
                </select>
            </div>

            <div id="custom-splits" class="split-inputs-container"></div>

            <button type="submit" class="submit-button">Add Expense</button>
        </form>
    </div>

    <script src="/miniapp.js"></script>
    <script>
        const params = MiniApp.getParams();
        const groupId = parseInt(params.get('group_id'));
        const userId = MiniApp.getUserId();

        let groupUsers = [];
        let selectedUsers = [];
        const billPhotoHandler = new FileUploadHandler('bill-photo', 'bill-preview');
        const vendorSlipHandler = new FileUploadHandler('vendor-slip', 'vendor-preview');

        async function init() {
            if (!groupId || !userId) {
                MiniApp.showError('Missing group or user information');
                return;
            }

            // Setup back button
            MiniApp.setupBackButton(`/app.html?group_id=${groupId}`);

            try {
                const response = await fetch(window.location.origin + '/api/group-users?group_id=' + groupId);
                if (!response.ok) throw new Error('Failed to load group users');

                const data = await response.json();
                groupUsers = data.users;

                document.getElementById('group-name').textContent = data.group_title || 'Group ' + groupId;
                populateUsers();
                MiniApp.hideLoading();
                document.getElementById('expense-form').style.display = 'block';
            } catch (error) {
                MiniApp.showError('Failed to load group information');
                console.error(error);
            }
        }

        function populateUsers() {
            const paidBySelect = document.getElementById('paid-by');
            const userSelection = document.getElementById('user-selection');

            groupUsers.forEach(user => {
                // Populate paid by dropdown
                const option = document.createElement('option');
                option.value = user.telegram_id;
                option.textContent = user.first_name + (user.username ? ' (@' + user.username + ')' : '');
                paidBySelect.appendChild(option);

                // Create user chip
                const chip = document.createElement('div');
                chip.className = 'user-chip';
                chip.dataset.userId = user.telegram_id;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = user.telegram_id;
                checkbox.id = 'user-' + user.telegram_id;

                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.textContent = MiniApp.getInitial(user.first_name);

                const info = document.createElement('div');
                info.className = 'user-info';

                const name = document.createElement('div');
                name.className = 'user-name';
                name.textContent = user.first_name;

                const username = document.createElement('div');
                username.className = 'user-username';
                username.textContent = user.username ? '@' + user.username : 'ID: ' + user.telegram_id;

                info.appendChild(name);
                info.appendChild(username);

                const check = document.createElement('div');
                check.className = 'user-check';

                chip.appendChild(checkbox);
                chip.appendChild(avatar);
                chip.appendChild(info);
                chip.appendChild(check);

                chip.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        checkbox.checked = !checkbox.checked;
                    }
                    chip.classList.toggle('selected', checkbox.checked);
                    updateSelectedUsers();
                    MiniApp.haptic('light');
                });

                userSelection.appendChild(chip);
            });

            // Set current user as default payer
            if (userId) paidBySelect.value = userId;
        }

        function updateSelectedUsers() {
            selectedUsers = Array.from(document.querySelectorAll('#user-selection input:checked'))
                .map(cb => parseInt(cb.value));

            const countBadge = document.getElementById('selected-count');
            if (selectedUsers.length > 0) {
                countBadge.textContent = selectedUsers.length + ' selected';
                countBadge.style.display = 'inline-flex';
            } else {
                countBadge.style.display = 'none';
            }

            updateCustomSplits();
        }

        // Select all / Deselect all
        document.getElementById('select-all').addEventListener('click', () => {
            document.querySelectorAll('#user-selection input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
                cb.closest('.user-chip').classList.add('selected');
            });
            updateSelectedUsers();
            MiniApp.haptic('medium');
        });

        document.getElementById('deselect-all').addEventListener('click', () => {
            document.querySelectorAll('#user-selection input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.closest('.user-chip').classList.remove('selected');
            });
            updateSelectedUsers();
            MiniApp.haptic('light');
        });

        // Split type change handler
        document.getElementById('split-type').addEventListener('change', updateCustomSplits);

        function updateCustomSplits() {
            const splitType = document.getElementById('split-type').value;
            const customSplitsDiv = document.getElementById('custom-splits');

            if (splitType === 'custom' && selectedUsers.length > 0) {
                customSplitsDiv.className = 'split-inputs-container visible';
                customSplitsDiv.innerHTML = '<div class="split-inputs-title">Enter custom amounts:</div>';

                selectedUsers.forEach(userId => {
                    const user = groupUsers.find(u => u.telegram_id === userId);
                    const row = document.createElement('div');
                    row.className = 'split-input-row';

                    const label = document.createElement('div');
                    label.className = 'split-user-label';
                    label.textContent = user.first_name;

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'split-amount-input';
                    input.step = '0.01';
                    input.min = '0';
                    input.placeholder = '0.00';
                    input.dataset.userId = userId;

                    row.appendChild(label);
                    row.appendChild(input);
                    customSplitsDiv.appendChild(row);
                });
            } else {
                customSplitsDiv.className = 'split-inputs-container';
                customSplitsDiv.innerHTML = '';
            }
        }

        // Form submission
        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (selectedUsers.length === 0) {
                MiniApp.showError('Please select at least one user to split with');
                return;
            }

            const formData = new FormData();
            formData.append('group_id', groupId);
            formData.append('amount', document.getElementById('amount').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('location', document.getElementById('location').value);
            formData.append('paid_by', document.getElementById('paid-by').value);
            formData.append('split_type', document.getElementById('split-type').value);
            formData.append('selected_users', JSON.stringify(selectedUsers));

            if (document.getElementById('split-type').value === 'custom') {
                const customSplits = {};
                document.querySelectorAll('#custom-splits input').forEach(input => {
                    customSplits[input.dataset.userId] = parseFloat(input.value) || 0;
                });
                formData.append('custom_splits', JSON.stringify(customSplits));
            }

            if (billPhotoHandler.hasFile()) {
                formData.append('bill_photo', billPhotoHandler.getFile());
            }

            if (vendorSlipHandler.hasFile()) {
                formData.append('vendor_slip', vendorSlipHandler.getFile());
            }

            try {
                const submitBtn = document.querySelector('.submit-button');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Adding...';

                const result = await MiniApp.apiRequest('/api/add-expense', {
                    method: 'POST',
                    body: formData
                });

                console.log('Expense added successfully:', result);
                MiniApp.haptic('success');

                // Navigate back to main menu
                window.location.href = `/app.html?group_id=${groupId}`;
            } catch (error) {
                console.error('Error adding expense:', error);
                MiniApp.showError(error.message || 'Failed to add expense. Please try again.');
                const submitBtn = document.querySelector('.submit-button');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Expense';
            }
        });

        init();
    </script>
</body>
</html>
